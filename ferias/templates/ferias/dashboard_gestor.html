{% extends 'ferias/base.html' %}
{% load static %}

{% block content %}
    <h2 class="titulo-secao">Painel do Gestor</h2>
    <h3>Solicitações Pendentes</h3>

    {% if solicitacoes_pendentes %}
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Funcionário</th>
                        <th>Período Solicitado</th>
                        <th>Total de Dias</th>
                        <th>Período(s) Aquisitivo(s)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in solicitacoes_pendentes %}
                    <tr>
                        <td>{{ s.solicitante.get_full_name|default:s.solicitante.username }}</td>
                        <td>{{ s.data_inicio|date:"d/m/Y" }} a {{ s.data_fim|date:"d/m/Y" }}</td>
                        <td>{{ s.total_dias }}</td>
                        <td>
                            {% for periodo in s.periodos_utilizados.all %}
                                {{ periodo.data_inicio_aquisitivo.year }}/{{ periodo.data_fim_aquisitivo.year }}
                                {% if not forloop.last %}e {% endif %}
                            {% empty %}
                                N/A
                            {% endfor %}
                        </td>
                        <td>
                            <div class="acoes-container">
                                <form action="{% url 'ferias:aprovar_solicitacao' s.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="botao-sucesso">Aprovar</button>
                                </form>
                                <button type="button" class="botao-perigo js-modal-trigger" data-target="#rejeitarModal-{{ s.pk }}">
                                    Rejeitar
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alerta-info">Nenhuma solicitação pendente na sua equipe.</div>
    {% endif %}

    {% for s in solicitacoes_pendentes %}
    <div class="modal" id="rejeitarModal-{{ s.pk }}">
        <div class="modal-conteudo">
            <form action="{% url 'ferias:rejeitar_solicitacao' s.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h3>Rejeitar Solicitação</h3>
                    <button type="button" class="modal-fechar js-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Funcionário: <strong>{{ s.solicitante.get_full_name|default:s.solicitante.username }}</strong></p>
                    <p>Período: <strong>{{ s.data_inicio|date:"d/m/Y" }} a {{ s.data_fim|date:"d/m/Y" }}</strong></p>
                    <div class="campo-form">
                        <label for="motivo_rejeicao-{{ s.pk }}">Motivo da Rejeição (obrigatório):</label>
                        <textarea class="input-form" name="motivo_rejeicao" id="motivo_rejeicao-{{ s.pk }}" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="botao-secundario js-modal-close">Cancelar</button>
                    <button type="submit" class="botao-perigo">Confirmar Rejeição</button>
                </div>
            </form>
        </div>
    </div>
    {% endfor %}

<style>
    .titulo-secao { margin-bottom: 10px; }
    .acoes-container { display: flex; gap: 10px; }
    .card table { margin-bottom: 0; }
</style>
{% endblock %}